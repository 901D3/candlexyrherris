<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" name="viewport" content="width=device-width,initial-scale=1" />
    <title data-text="$title"></title>
    <meta name="description" content="A tool for audio processing and playback" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/unifont@5.1.0/index.min.css" />
    <link rel="icon" href="favicon.ico" />
    <script src="https://unpkg.com/default-passive-events"></script>
  </head>
  <body class="display-flex top-bottom-flow" style="gap: 8px">
    <div class="display-flex top-bottom-flow" style="gap: 15px">
      <span
        class="glowfire font-size text-align-center vertical-align-top-margin color font-weight-bold"
        style="--font-size: 175px"
        data-text="$title"></span>
      <span class="text-align-center font-weight-bold font-size" style="--font-size: 25px" data-text="$subtitle"></span>
      <div class="firehr"></div>
    </div>
    <div class="display-flex left-right-flow width-fit-content" style="gap: 15px">
      <div class="display-flex top-bottom-flow" style="gap: 12px">
        <span class="font-weight-bold" style="font-size: 20px" data-text="$upload"></span>
        <input
          type="file"
          id="uploadFile"
          class="height-fit-content"
          title=".wav, .flac, .mp3, .ogg, .opus, .m4a, .mp4, .mkv, .webm"
          accept=".wav, .flac, .mp3, .ogg, .opus, .m4a, .mp4, .mkv, .webm" />
        <input type="text" id="linkUrl" placeholder="Audio link(must point to an audio file)" />
        <button
          id="updateAudioSrc"
          onclick="updateAudioSrc()"
          class="height-fit-content"
          style="width: 60px"
          data-text="$update"></button>
        <span class="font-weight-bold" style="font-size: 20px" data-text="$image"></span>
        <input
          type="file"
          id="uploadImageFile"
          class="height-fit-content"
          title=".png, .jpg, .jpeg, .webp, .gif, .bmp"
          accept=".png, .jpg, .jpeg, .webp, .gif, .bmp" />
        <input type="text" id="imageLinkUrl" placeholder="Image link(must point to an image file)" />
        <button
          id="updateImageSrc"
          onclick="updateImageSrc()"
          class="height-fit-content"
          style="width: 60px"
          data-text="$update"></button>
      </div>
      <div class="display-flex top-bottom-flow width-fit-content" style="gap: 12px">
        <span class="font-weight-bold" style="font-size: 20px" data-text="$recorder"></span>
        <div class="display-flex left-right-flow width-fit-content" style="gap: 12px">
          <button id="startRecording" class="sqrButton" type="button" disabled="">
            <div class="horizontal-align-center vertical-align-center-margin record"></div>
          </button>
          <button id="stopRecording" class="sqrButton" type="button" disabled="">
            <div class="horizontal-align-center vertical-align-center-margin stopRecord"></div>
          </button>
          <!--<span class="vertical-align-center-margin">[F1] [SHIFT + F1]</span>-->
          <button id="startRendering" type="button" class="sqrButton" disabled="">
            <div>|-></div>
          </button>
          <button id="stopRendering" class="sqrButton" type="button" disabled="">
            <div>stop render-ing</div>
          </button>
        </div>
        <div class="display-flex left-right-flow width-fit-content" style="gap: 12px">
          <button id="pauseRecording" class="sqrButton" disabled="" type="button">
            <div
              class="horizontal-align-center width-fit-content height-fit-content display-flex left-right-flow"
              style="gap: 6px">
              <div class="vertical-align-center-margin" style="width: 5px; height: 16px; background-color: #fff"></div>
              <div class="vertical-align-center-margin" style="width: 5px; height: 16px; background-color: #fff"></div>
            </div>
          </button>
          <button id="resumeRecording" class="sqrButton" type="button" disabled="">
            <div>resume</div>
          </button>
          <button id="pauseRendering" class="sqrButton" disabled="" type="button">
            <div
              class="horizontal-align-center width-fit-content height-fit-content display-flex left-right-flow"
              style="gap: 6px">
              <div class="vertical-align-center-margin" style="width: 5px; height: 16px; background-color: #f70"></div>
              <div class="vertical-align-center-margin" style="width: 5px; height: 16px; background-color: #f70"></div>
            </div>
          </button>
          <button id="resumeRendering" class="sqrButton" type="button" disabled="">
            <div>resume</div>
          </button>
          <!--<span class="vertical-align-center-margin">[F4]</span>-->
        </div>
      </div>
      <div class="settings_container">
        <div class="settings_label-input_long">
          <span data-text="$start_position"></span>
          <input id="rendererStartPosition" value="0" />
        </div>
      </div>
      <div class="settings_container">
        <div class="settings_label-input_long tooltip">
          <span data-text="$mime_type"></span>
          <input id="recorderMimeTypeInput" placeholder="video/webm" value="video/webm" />
        </div>
        <div class="settings_label-input_long">
          <span data-text="$codec"></span>
          <input id="recorderCodecInput" placeholder="vp9" value="vp9" />
        </div>
        <div class="settings_label-slider-input">
          <span data-text="$frame_rate"></span>
          <input type="range" id="recorderFrameRateRange" min="0" max="120" step="0.00000000001" />
          <input type="number" id="recorderFrameRateInput" placeholder="30" value="30" />
        </div>
        <div class="settings_label-slider-input">
          <span data-text="$bitrate"></span>
          <input type="range" id="recorderVideoBitrateRange" min="0" max="100000000" step="1" />
          <input type="number" id="recorderVideoBitrateInput" placeholder="2000000" value="2000000" />
        </div>
        <div class="settings_label-input_long">
          <span data-text="$file_name"></span>
          <input id="recorderFileName" placeholder="" value="" />
        </div>
      </div>
      <div class="settings_container">
        <div class="settings_label-slider-input">
          <span data-text="$webp_quality"></span>
          <input type="range" id="webmWriterQualityRange" min="0" max="1" step="0.00000000001" />
          <input type="number" id="webmWriterQualityInput" placeholder="0.90" value="0.90" />
        </div>
        <div class="settings_label-input">
          <span data-text="$max_concurrent_encodes"></span>
          <input type="number" id="rendererMaxConcurrentEncodes" placeholder="2" value="2" />
        </div>
      </div>
    </div>
    <div class="bigContainer left-right-flow" style="gap: 20px">
      <div class="controls">
        <div class="settings_container">
          <span class="settings_label_title" data-text="$audio_settings_title"></span>
          <div class="settings_label-slider-input">
            <span data-text="$pre_vol_multiplier"></span>
            <input type="range" id="preVolumeMultiplierRange" min="0" max="10" step="0.00000000001" />
            <input type="number" id="preVolumeMultiplierInput" placeholder="1" value="1" />
          </div>
          <div class="settings_label-slider-input">
            <span data-text="$post_vol_multiplier"></span>
            <input type="range" id="postVolumeMultiplierRange" min="0" max="10" step="0.00000000001" />
            <input type="number" id="postVolumeMultiplierInput" placeholder="1" value="1" />
          </div>
          <div class="settings_label-slider-input tooltip">
            <span class="tooltipTextRight" data-text="$fftSizeTooltip"></span>
            <span data-text="$fft_size"></span>
            <input type="range" id="fftSizeRange" min="1" max="16384" step="1" />
            <input type="number" id="fftSizeInput" placeholder="1600" value="1600" />
          </div>
          <div class="settings_label-slider-input">
            <span data-text="$min_amplitude"></span>
            <input type="range" id="minAmplitudeRange" min="0" max="1" step="0.00000000001" />
            <input type="number" id="minAmplitudeInput" placeholder="0" value="0" />
          </div>
          <div class="settings_label-slider-input">
            <span data-text="$max_amplitude"></span>
            <input type="range" id="maxAmplitudeRange" min="0" max="1" step="0.00000000001" />
            <input type="number" id="maxAmplitudeInput" placeholder="1.1" value="1.1" />
          </div>
          <div class="settings_label-slider-input">
            <span data-text="$threshold"></span>
            <input type="range" id="thresholdRange" min="0" max="1" step="0.00000000001" />
            <input type="number" id="thresholdInput" placeholder="0" value="0" />
          </div>
          <div class="settings_label-slider-input">
            <span data-text="$amplitude_offset"></span>
            <input type="range" id="amplitudeOffsetRange" min="0" max="1" step="0.00000000001" />
            <input type="number" id="amplitudeOffsetInput" placeholder="0" value="0" />
          </div>
          <div class="settings_label-slider-input">
            <span data-text="$min_bin"></span>
            <input type="range" id="minBinRange" min="0" max="5000" step="1" />
            <input type="number" id="minBinInput" placeholder="0" value="0" />
          </div>
          <div class="settings_label-slider-input tooltip">
            <span data-text="$max_bin"></span>
            <input type="range" id="maxBinRange" min="0" max="5000" step="1" />
            <input type="number" id="maxBinInput" placeholder="100" value="100" />
          </div>
          <div class="settings_label-select">
            <span data-text="$bin_value_picking"></span>
            <select id="binValuePicking">
              <option value="first" selected="true" data-text="$first"></option>
              <option value="max" data-text="$max"></option>
              <option value="avg" data-text="$average"></option>
              <option value="rms" data-text="$RMS"></option>
            </select>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$min_frequency"></span>
            <span id="minFreqLbl" class="info">Hz</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$max_frequency"></span>
            <span id="maxFreqLbl" class="info">Hz</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$freq_range"></span>
            <span id="freqRangeLbl" class="info">Hz</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$bin_range"></span>
            <span id="binRangeLbl" class="info">[Int]</span>
          </div>
          <div class="whitehr"></div>
          <div class="settings_label-select">
            <span data-text="$window_function"></span>
            <select id="windowFuncSelect">
              <option value="rect" selected="true" data-text="$rect"></option>
              <option value="ramp" data-text="$ramp"></option>
              <option value="triangular" data-text="$triangular"></option>
              <option value="welch" data-text="$welch"></option>
              <option value="cosine" data-text="$cosine"></option>
              <option value="bartlett" data-text="$bartlett"></option>
              <option value="barthann" data-text="$barthann"></option>
              <option value="hann" data-text="$hann"></option>
              <option value="hamming" data-text="$hamming"></option>
              <option value="blackman" data-text="$blackman"></option>
              <option value="nuttall" data-text="$nuttall"></option>
              <option value="blackmanNuttall" data-text="$blackman_nuttall"></option>
              <option value="blackmanHarris" data-text="$blackman_harris"></option>
              <option value="flatTop" data-text="$flat_top"></option>
              <option value="bartlettHann" data-text="$bartlett_hann"></option>
              <option value="gaussian" data-text="$gaussian"></option>
              <option value="exponential" data-text="$exponential"></option>
              <option value="lanczos" data-text="$lanczos"></option>
              <option value="fun1">fun1</option>
            </select>
          </div>
          <textarea id="windowFuncInput">1</textarea>
          <div class="settings_label-slider-input">
            <span>Real array shift</span>
            <input type="range" id="realShiftRange" min="0" max="10" step="1" />
            <input type="number" id="realShiftInput" placeholder="0" value="0" />
          </div>
          <div class="settings_label-slider-input">
            <span>Imaginary array shift</span>
            <input type="range" id="imagShiftRange" min="0" max="10" step="1" />
            <input type="number" id="imagShiftInput" placeholder="0" value="0" />
          </div>
          <div class="settings_checkbox-label">
            <input
              type="checkbox"
              id="interleaveEffect"
              onchange="interleaveEffect = document.getElementById('interleaveEffect').checked;displayInfo()" />
            <span data-text="$Interleave"></span>
          </div>
          <div class="settings_checkbox-label">
            <input
              type="checkbox"
              id="interleaveEffectFix"
              checked=""
              onchange="interleaveEffectFix = document.getElementById('interleaveEffectFix').checked" />
            <span>Second bar fix(Interleaved only)</span>
          </div>
          <div class="whitehr"></div>
          <span class="settings_label_title" data-text="$visualizer_settings_title"></span>
          <div class="settings_label-select">
            <span data-text="$bar_style"></span>
            <select id="barStyle">
              <option value="rect" selected="true" data-text="$rect"></option>
              <option value="capsule" data-text="$capsule"></option>
              <option value="triangCapsule" data-text="$triangle_capsule"></option>
              <option value="oval" data-text="$oval"></option>
              <option value="lines" data-text="$lines"></option>
            </select>
          </div>
          <div class="settings_checkbox-label">
            <input type="checkbox" id="barOutline" onchange="barOutline = document.getElementById('barOutline').checked" />
            <span>Outline</span>
          </div>
          <div id="capsuleSettingsDisp" class="settings_label-slider-input disabled">
            <span data-text="$capsule_radius"></span>
            <input type="range" id="barStyleCapsuleRadiusRange" min="0" max="0.5" step="0.00000000001" />
            <input type="number" id="barStyleCapsuleRadiusInput" placeholder="0.5" value="0.5" />
          </div>
          <div id="triangCapsuleSettingsDisp" class="settings_label-slider-input disabled">
            <span data-text="$triangle_capsule_height"></span>
            <input type="range" id="barStyleTriangCapsuleHeightRange" min="0" max="1" step="0.00000000001" />
            <input type="number" id="barStyleTriangCapsuleHeightInput" placeholder="1" value="1" />
          </div>
          <div class="whitehr"></div>
          <div class="settings_label-slider-input">
            <span data-text="$number"></span>
            <input type="range" id="barsRange" min="1" value="100" max="512" step="1" />
            <input type="number" id="barsInput" placeholder="100" value="100" />
          </div>
          <div class="settings_label-slider-input">
            <span data-text="$width"></span>
            <input type="range" id="barWidthRange" min="0.1" max="100" step="0.00000000001" />
            <input type="number" id="barWidthInput" placeholder="10" value="10" />
          </div>
          <div class="settings_label-slider-input">
            <span data-text="$space"></span>
            <input type="range" id="barSpaceRange" min="0" max="100" step="0.00000000001" />
            <input type="number" id="barSpaceInput" placeholder="1" value="1" />
          </div>
          <div class="settings_label-slider-input" style="background-color: #ff0000">
            <span></span>
            <input type="range" id="barColorRedRange" min="0" max="255" step="1" />
            <input type="number" id="barColorRedInput" placeholder="255" value="255" />
          </div>
          <div class="settings_label-slider-input" style="background-color: #00ff00">
            <span></span>
            <input type="range" id="barColorGreenRange" min="0" max="255" step="1" />
            <input type="number" id="barColorGreenInput" placeholder="255" value="255" />
          </div>
          <div class="settings_label-slider-input" style="background-color: #0000ff">
            <span></span>
            <input type="range" id="barColorBlueRange" min="0" max="255" step="1" />
            <input type="number" id="barColorBlueInput" placeholder="255" value="255" />
          </div>
          <div class="settings_checkbox-label">
            <input
              type="checkbox"
              id="barAmplitudeRounding"
              onchange="barAmplitudeRounding = document.getElementById('barAmplitudeRounding').checked" />
            <span>Amplitude Rounding</span>
          </div>
          <div class="settings_checkbox-label">
            <input
              type="checkbox"
              id="barWidthRounding"
              onchange="barWidthRounding = document.getElementById('barWidthRounding').checked" />
            <span>Width Rounding</span>
          </div>
          <div class="whitehr"></div>
          <div class="settings_label-select">
            <span data-text="$background_style"></span>
            <select id="backgroundStyle">
              <option value="solidColor" selected="true" data-text="$solid_color"></option>
              <option value="image" data-text="$image"></option>
            </select>
          </div>
          <div class="settings_label-slider-input" style="background-color: #ff0000">
            <span></span>
            <input type="range" id="backgroundColorRedRange" min="0" max="255" step="1" />
            <input type="number" id="backgroundColorRedInput" placeholder="50" value="50" />
          </div>
          <div class="settings_label-slider-input" style="background-color: #00ff00">
            <span></span>
            <input type="range" id="backgroundColorGreenRange" min="0" max="255" step="1" />
            <input type="number" id="backgroundColorGreenInput" placeholder="50" value="50" />
          </div>
          <div class="settings_label-slider-input" style="background-color: #0000ff">
            <span></span>
            <input type="range" id="backgroundColorBlueRange" min="0" max="255" step="1" />
            <input type="number" id="backgroundColorBlueInput" placeholder="50" value="50" />
          </div>
          <div class="settings_label-slider-input">
            <span data-text="$frame_rate"></span>
            <input type="range" id="frameRateRange" min="0" max="120" step="0.00000000001" />
            <input type="number" id="frameRateInput" placeholder="30" value="30" />
          </div>
          <div class="whitehr"></div>
          <div class="settings_label-input">
            <span data-text="$width"></span>
            <input type="number" id="canvasWidth" placeholder="1280" value="1280" />
          </div>
          <div class="settings_label-input">
            <span data-text="$height"></span>
            <input type="number" id="canvasHeight" placeholder="720" value="720" />
          </div>
          <div class="settings_button-label">
            <button onclick="changecanvasSize()" data-text="$canvas_size_change"></button>
          </div>
          <div class="settings_checkbox-label">
            <input
              type="checkbox"
              id="canvasRendering"
              checked=""
              onchange="document.getElementById('canvas').style.imageRendering =
                document.getElementById('canvasRendering').checked ? 'pixelated' : 'smooth';" />
            <span data-text="$pixelated_render"></span>
          </div>
          <div class="settings_checkbox-label">
            <input
              type="checkbox"
              id="desyncOpt"
              onchange='
              ctx = canvas.getContext("2d", {
                willReadFrequently: true,
                alpha: false,
                colorSpace: "srgb",
                colorType: "float16",
                desynchronized: document.getElementById("desyncOpt").checked,
              });' />
            <span data-text="$canvas_desync"></span>
          </div>
          <div class="settings_button-label">
            <button onclick="fullscreenCanvas()" data-text="$canvas_fullscreen"></button>
            <span>[F]</span>
          </div>
        </div>
        <div class="whitehr"></div>
        <div class="settings_container_info">
          <span class="info_indicator">i</span>
          <div class="settings_label-label_info">
            <span data-text="$sample_rate"></span>
            <span id="sampleRateLbl" class="info">Hz</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$bit_depth"></span>
            <span id="bitDepthLbl" class="info">Bits</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$number_of_channels"></span>
            <span id="channelsLbl" class="info">[Int]</span>
          </div>
          <div class="whitehr"></div>
          <div class="settings_label-label_info">
            <span data-text="$audio_duration"></span>
            <span id="audioDurationLbl" class="info">[Float]</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$audio_data_length"></span>
            <span id="audioDataLengthLbl" class="info">[Int]</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$window_length"></span>
            <span id="windowLengthLbl" class="info">ms</span>
          </div>
          <div class="whitehr"></div>
          <div class="settings_label-label_info">
            <span data-text="$freq_pre_bar"></span>
            <span id="freqPerBarLbl" class="info">Hz</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$bars_per_freq"></span>
            <span id="barsPerFreqLbl" class="info">[Float]</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$bins_per_bar"></span>
            <span id="binsPerBarLbl" class="info">[Float]</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$bars_per_bin"></span>
            <span id="barsPerBinLbl" class="info">[Float]</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$bins_per_freq"></span>
            <span id="binsPerFreqLbl" class="info">[Float]</span>
          </div>
          <div class="settings_label-label_info">
            <span data-text="$freq_pre_bin"></span>
            <span id="freqPerBinLbl" class="info">Hz</span>
          </div>
        </div>
      </div>
      <div class="previewContainer">
        <div class="mainAudio">
          <div class="settings_label-select">
            <span data-text="$channel"></span>
            <select id="audioChannel">
              <option value="left" selected="true" data-text="$left"></option>
              <option value="right" data-text="$right"></option>
            </select>
          </div>
          <div class="firehr"></div>
          <audio id="audio" controls loop crossorigin="anonymous" src="" data-text="$elN_A"></audio>
        </div>
        <div class="firehr"></div>
        <div class="mainCanvas">
          <canvas id="canvas" width="1280" height="720" data-text="$elN_A"></canvas>
        </div>
      </div>
    </div>
    <div class="settings_container">
      <div class="settings_checkbox-label">
        <input type="checkbox" id="showTelemetries" />
        <span data-text="$Telemetries"></span>
      </div>
    </div>
    <div class="border-width border-style-solid border-color" style="--border-width: 2px; --border-color: #1070ea">
      <div id="console"></div>
    </div>
    <div class="firehr"></div>
  </body>
  <script src="scripts/init.js"></script>

  <!--Resources-->
  <script src="scripts/resource/windowFunc.js"></script>

  <!--Libraries-->
  <script src="scripts/lib/901D3/binUtils.js"></script>
  <script src="scripts/lib/901D3/wav.js"></script>
  <script src="scripts/lib/thenickdude/webm-writer-0.3.0.js"></script>

  <!--FFTs-->
  <!--<script src="scripts/lib/wendykierp/base.js"></script>-->
  <!--<script src="scripts/lib/wendykierp/mixed_radix/mixed_radix.js"></script>-->
  <!--<script src="scripts/lib/wendykierp/mixed_radix/passes.js"></script>-->
  <script src="scripts/lib/nayuki/fft.js"></script>

  <!--Decoders-->
  <script src="scripts/lib/webaudioAPI/audioBuffer.js"></script>

  <script src="scripts/recorder.js"></script>
  <script src="scripts/locale.js"></script>
  <script src="scripts/sizing.js"></script>
  <script src="scripts/audio.js"></script>
  <script src="scripts/misc.js"></script>
  <script src="scripts/process.js"></script>
  <script src="scripts/drawer.js"></script>
  <script>
    const upload = gId("uploadFile");
    const uploadImg = gId("uploadImageFile");
    upload.addEventListener("change", async () => {
      let t0 = performance.now();
      const file = upload.files[0];
      if (!file) return;
      let buffer = await file.arrayBuffer();
      bytesArray = new Uint8Array(buffer);
      const wavInfo = wavjs.readWavHeader(bytesArray);
      const flacInfo = binUtils.binSearch(bytesArray, [0x66, 0x4c, 0x61, 0x43], 0, 4) !== false;
      const mp3Info = binUtils.binSearch(bytesArray, [0x49, 0x44, 0x33], 0, 3) !== false;
      const oggInfo = binUtils.binSearch(bytesArray, [0x4f, 0x67, 0x67, 0x53], 0, 4) !== false;
      const m4aInfo = binUtils.isM4A(bytesArray) !== false;
      audio.pause();

      if (wavInfo !== false) {
        printLog("File type: wav");
        format = wavInfo.format;
        channels = wavInfo.channels;
        sampleRate = wavInfo.sampleRate;
        bitDepth = wavInfo.bitDepth;
        await new Promise((resolve) => {
          setTimeout(() => {
            const array = wavjs.convertWavData(sampleRate, bitDepth, format, wavInfo.outArray, 1);
            leftChannelArray = array.leftChannel;
            rightChannelArray = array.rightChannel;
            resolve();
          }, 0);
        });
      } else {
        let result = await audioBufferDecode.decode(bytesArray);

        channels = result.channels;
        sampleRate = result.sampleRate;
        leftChannelArray = result.leftChannel;
        rightChannelArray = result.rightChannel;
        bitDepth = "Unknown";
      }

      bytesArray = [];
      gId("startRecording").removeAttribute("disabled");
      gId("startRendering").removeAttribute("disabled");

      audio.src = URL.createObjectURL(file);
      displayInfo();
      printLog("Initializing took " + (performance.now() - t0) + "ms");
    });

    uploadImg.addEventListener("change", function () {
      const file = uploadImg.files[0];

      image = new Image();
      image.crossOrigin = "";
      image.src = URL.createObjectURL(file);
    });

    async function updateAudioSrc() {
      let t0 = performance.now();
      try {
        await fetch(gId("linkUrl").value);
      } catch (e) {
        printLog(e);
        return;
      }

      bytesArray = new Uint8Array(buffer);
      const wavInfo = wavjs.readWavHeader(bytesArray);
      const flacInfo = binUtils.binSearch(bytesArray, [0x66, 0x4c, 0x61, 0x43], 0, 4) !== false;
      const mp3Info = binUtils.binSearch(bytesArray, [0x49, 0x44, 0x33], 0, 3) !== false;
      const oggInfo = binUtils.binSearch(bytesArray, [0x4f, 0x67, 0x67, 0x53], 0, 4) !== false;
      const m4aInfo = binUtils.isM4A(bytesArray) !== false;
      audio.pause;

      if (wavInfo !== false) {
        printLog("File type: wav");
        format = wavInfo.format;
        channels = wavInfo.channels;
        sampleRate = wavInfo.sampleRate;
        bitDepth = wavInfo.bitDepth;
        await new Promise((resolve) => {
          setTimeout(() => {
            const array = wavjs.convertWavData(sampleRate, bitDepth, format, wavInfo.outArray, 1);
            leftChannelArray = array.leftChannel;
            rightChannelArray = array.rightChannel;
            resolve();
          }, 0);
        });
      } else {
        let result = await audioBufferDecode.decode(bytesArray);

        channels = result.channels;
        sampleRate = result.sampleRate;
        leftChannelArray = result.leftChannel;
        rightChannelArray = result.rightChannel;
        bitDepth = "Unknown";
      }

      bytesArray = [];
      gId("startRecording").removeAttribute("disabled");
      gId("startRendering").removeAttribute("disabled");

      audio.src = linkUrl;
      displayInfo();
      printLog("Initializing took " + (performance.now() - t0) + "ms");
    }

    async function updateImageSrc() {
      let t0 = performance.now();
      try {
        await fetch(gId("imageLinkUrl").value);
      } catch (e) {
        printLog(e);
        return;
      }

      image = new Image();
      image.crossOrigin = "";
      image.src = gId("imageLinkUrl").value;
    }

    function fullscreenCanvas() {
      if (canvas.requestFullscreen) {
        canvas.requestFullscreen();
      } else if (canvas.webkitRequestFullscreen) {
        canvas.webkitRequestFullscreen();
      } else if (canvas.msRequestFullscreen) {
        canvas.msRequestFullscreen();
      }
    }

    function isFirefox() {
      const testCanvas = document.createElement("canvas");
      return "mozOpaque" in testCanvas;
    }
    if (isFirefox()) {
      canvas.setAttribute("moz-opaque", "");
    }
  </script>
</html>
